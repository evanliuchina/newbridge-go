<html>
  <head>
    <title>newbridge-go</title>
		<style>
			body {
				font-family: monospace;
			}
		</style>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery.qrcode/1.0/jquery.qrcode.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bitcoinjs-lib/0.2.0-1/bitcoinjs-min.js"></script> 
		<script src="newchain-util.js"></script>
		<script>
			/*
			const URL_NEW2ETH = "http://52.199.194.251:8801/v1/bridge/account?direction=new2eth&ethereum_recipient_address=";
			const URL_ETH2NEW = "http://52.199.194.251:8801/v1/bridge/account?direction=eth2new&newchain_recipient_address=";
			*/
			const URL = "http://52.199.194.251:8801/v1/bridge/account";
			const URL_TESTNET = "http://52.199.194.251:8801/v1/bridge/account";
			const NETWORK = {
				"1": {
					name: "ethereum", //eth main-net
					url: URL,
					direction: "new2eth"
				},
				"4": {
					name: "rinkeby", //rinkeby test-net
					url: URL_TESTNET,
					direction: "new2eth"
				},
				"1012": {
					name: "newchain", //newchain main-net
					url: URL,
					direction: "eth2new"
				},
				"1007": {
					name: "newchain_testnet", //newchain test-net
					url: URL_TESTNET,
					direction: "eth2new"
				}
			};

			function print(msg) {
				$("<div>").text(msg).appendTo("body");
			}

			function show_qrcode(text) {
				var obj = $("<div>");
				obj.qrcode(text);
				obj.appendTo("body");
			}

			window.addEventListener("load", async () => {
        print("ready");

				// if metamask is ready
				if (window.ethereum) {
					window.web3 = new Web3(ethereum);

					try { //log in
						await ethereum.enable();
					} catch (err) { //user denied
						print("ERROR: login denied");
						return; //quit
					}
				} else {
					print("ERROR: metamask not found");
					return; //quit
				}

				// get chainId
				var chain_id = web3.version.network;
				print("network: " + NETWORK[chain_id].name + "(" + chain_id + ")");

				var is_newchain = false;
				if (chain_id == 1007 || chain_id == 1012) { //is newchain
					is_newchain = true;
				}

				if (NETWORK[chain_id] == undefined) {
					print("ERROR: unsupported network");
					return; //quit
				}

				// default account
				var account = web3.eth.defaultAccount;
				if (account == undefined) {
					print("ERROR: metamask not logged in");
					return; //quit
				}

				// go
				print("go go go");

				// the payload
				var data = {
					direction: NETWORK[chain_id].direction
				};
				print("direction: " + data.direction);

				if (is_newchain) {
					data["newchain_recipient_address"] = Newchain.hexAddress2NewAddress(account, chain_id);
					print("your receiving address on newchain: " + data.newchain_recipient_address + "(raw: " + account + ")");
				} else {
					data["ethereum_recipient_address"] = account;
					print("your receiving address on ethereum: " + data.ethereum_recipient_address);
				};

				$.ajax({
					url: NETWORK[chain_id].url,
					data: data,
					type: "GET",
					dataType: "json"
				}).fail((xhr, err) => {
					print("ERROR: " + xhr.responseText);
				}).done((json) => {
					console.log(JSON.stringify(json));

					if (is_newchain) {
						var ethereum_deposit_address = json["ethereum_deposit_address"];
						print("deposit address on ethereum: " + ethereum_deposit_address);
						show_qrcode("ethereum:" + ethereum_deposit_address);
						print("scan the above qrcode with an ethereum wallet app and transfer in NEW(ERC-20)/ETH/USDT, which will be sent to your newchain address " + data["newchain_recipient_address"]);
					} else {
						var newchain_deposit_address = json["newchain_deposit_address"];
						print("deposit address on newchain: " + newchain_deposit_address);
						show_qrcode("newton:" + newchain_deposit_address);
						print("scan the above qrcode with newpay and transfer in NEW/NETH/NUSDT, which will be sent to your ethereum address " + data["ethereum_recipient_address"]);
					}
				});
      });
    </script>
  </head>
  <body>
  </body>
</html>

